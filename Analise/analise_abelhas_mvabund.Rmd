---
title: "Composi√ß√£o/diversidade de comunidades de abelhas em fun√ß√£o da estrutura da paisagem"
subtitle: "Estrutura da Paisagem (propor√ß√£o de habitat natural x heterogeneidade) e Composi√ß√£o de Esp√©cies - VERS√ÉO MVABUND"
author: "Cinthia Soares Novaes"
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: flatly
    highlight: tango
    code_folding: show
    df_print: paged
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 7,
  fig.align = 'center'
)
```

# Introdu√ß√£o {.tabset}

## Contexto
*Pergunta: Como a composi√ß√£o e a diversidade de abelhas respondem √† estrutura da paisagem, considerando a propor√ß√£o de habitat natural e a heterogeneidade de usos e coberturas do solo?*

**H1:** A diversidade e a composi√ß√£o de abelhas est√£o mais fortemente associadas √† propor√ß√£o de habitat natural, de modo que √°reas com maior cobertura natural apresentam maior diversidade de esp√©cies.

**H2:** Mosaicos de diferentes classes de uso e cobertura do solo oferecem recursos complementares que sustentam maior diversidade e mant√™m comunidades distintas, tornando a heterogeneidade da paisagem um preditor mais importante.

**H0:** N√£o h√° associa√ß√£o significativa entre a propor√ß√£o de habitat natural e a heterogeneidade da paisagem e os padr√µes de diversidade e composi√ß√£o de abelhas neste estudo.

**Delineamento amostral:**
- **6 locais** com diferentes contextos (3 bordas urbanas + 3 zonas rurais)
- **Locais urbanos: TM, IF e MARM**
- **Locais rurais: CUR, SG e MV** 
- **9 pontos** por local (3 transectos √ó 3 pontos)
- **Total: 54 pontos amostrais**

## Objetivos

Os principais objetivos desta an√°lise s√£o:

1. **Diversidade Alfa**: Avaliar como a propor√ß√£o de habitat natural e a heterogeneidade da paisagem afetam a riqueza de esp√©cies (usando GLMM)
2. **Composi√ß√£o Beta**: Testar se √°reas de borda urbana diferem de zonas rurais usando modelos multivariados (mvabund)
3. **Identificar Esp√©cies Indicadoras**: Usar testes univariados para determinar quais esp√©cies respondem aos gradientes
4. **An√°lises Multivariadas**: Identificar padr√µes espaciais na estrutura das comunidades

## M√©todos Estat√≠sticos

- **GLMM (Modelo Misto)**: Riqueza por ponto (n=54) com Local como efeito aleat√≥rio
- **mvabund - manyglm()**: Modelos lineares generalizados multivariados
  - Testa efeitos de preditores na composi√ß√£o de esp√©cies
  - Fam√≠lia binomial negativa para dados de contagem
  - Testes multivariados e univariados
  - Permite incluir Local como bloco (similar ao ANOSIM bloqueado)
- **NMDS**: Ordena√ß√£o da composi√ß√£o de esp√©cies (para visualiza√ß√£o)
- **An√°lise Multiescala**: Compara√ß√£o entre pontos (n=54) e transectos (n=18)

---

# Configura√ß√£o Inicial

## Carregar Pacotes
```{r pacotes}
library(tidyverse)
library(readxl)
library(vegan)      # Para NMDS e diversidade
library(mvabund)    # *** PACOTE PRINCIPAL ***
library(lme4)       # Para GLMMs (diversidade alfa)
library(MuMIn)      # Sele√ß√£o de modelos
library(ggplot2)
library(viridis)
library(gridExtra)
library(car)        # Para VIF
```

## Importar e Limpar Dados
```{r importar-dados}
dados <- read_excel("../dados/Cap2.xlsx", sheet = "Doc_Cinthia")

dados <- dados %>%
  filter(
    Especie != "Vespa",
    Especie != "NA",
    !is.na(Especie),
    Especie != "Crabronidae sp.",
    Especie != "Xylocopa grisescens"
  ) %>%
  mutate(
    Especie = str_trim(Especie),
    total_paisagem = Area_Natural + Area_Urbana + Pastagem + Mosaico_Usos +
      Areas_nao_veg. + Mineracao + Lagos + Lavouras_Temp.,
    contexto = case_when(
      Local %in% c("TM_", "IF_", "MARM_") ~ "Borda_Urbana",
      Local %in% c("SG_", "MV_", "CUR_") ~ "Zona_Rural",
      TRUE ~ NA_character_
    ),
    ID_ponto = paste(Local, Ponto, sep = "_")
  )

cat("üìä DADOS CARREGADOS:\n")
cat("  - Total de registros:", nrow(dados), "\n")
cat("  - N√∫mero de esp√©cies:", n_distinct(dados$Especie), "\n")
cat("  - Locais amostrados:", n_distinct(dados$Local), "\n")
cat("  - Pontos √∫nicos:", n_distinct(dados$ID_ponto), "\n")
```

---

# Diversidade Alfa (GLMM - 54 pontos)

## Calcular Riqueza por Ponto
```{r riqueza-pontos}
riqueza_por_ponto <- dados %>%
  group_by(ID_ponto) %>%
  summarise(
    Local = first(Local),
    contexto = first(contexto),
    prop_hab_natural = first(Area_Natural) / first(total_paisagem),
    heterogeneidade = vegan::diversity(
      c(first(Area_Urbana), first(Pastagem), first(Mosaico_Usos),
        first(Areas_nao_veg.), first(Mineracao), first(Lagos), 
        first(Lavouras_Temp.)),
      index = "shannon"
    ),
    riqueza = n_distinct(Especie),
    abundancia = n(),
    .groups = "drop"
  )

cat("üìä Resumo da riqueza por ponto:\n")
print(summary(riqueza_por_ponto))

cat("\nüìà Estat√≠sticas descritivas:\n")
cat("  - Riqueza m√©dia:", round(mean(riqueza_por_ponto$riqueza), 2), "¬±", 
    round(sd(riqueza_por_ponto$riqueza), 2), "\n")
cat("  - Riqueza m√≠nima:", min(riqueza_por_ponto$riqueza), "\n")
cat("  - Riqueza m√°xima:", max(riqueza_por_ponto$riqueza), "\n")
```

## Modelos Lineares Generalizados Mistos (GLMM)

### Sele√ß√£o de Modelos
```{r glmm-selecao}
cat("\n=== AJUSTANDO GLMMs ===\n")
cat("Local √© inclu√≠do como efeito aleat√≥rio para controlar pseudorreplica√ß√£o\n\n")

# Centrar vari√°veis para reduzir multicolinearidade
riqueza_por_ponto <- riqueza_por_ponto %>%
  mutate(
    prop_hab_natural_c = scale(prop_hab_natural, center = TRUE, scale = FALSE)[,1],
    heterogeneidade_c = scale(heterogeneidade, center = TRUE, scale = FALSE)[,1]
  )

m1_c <- glmer(riqueza ~ prop_hab_natural_c + (1|Local), 
              data = riqueza_por_ponto, 
              family = poisson,
              control = glmerControl(optimizer = "bobyqa"))

m2_c <- glmer(riqueza ~ heterogeneidade_c + (1|Local), 
              data = riqueza_por_ponto, 
              family = poisson,
              control = glmerControl(optimizer = "bobyqa"))

m3_c <- glmer(riqueza ~ prop_hab_natural_c + heterogeneidade_c + (1|Local), 
              data = riqueza_por_ponto, 
              family = poisson,
              control = glmerControl(optimizer = "bobyqa"))

m4_c <- glmer(riqueza ~ prop_hab_natural_c * heterogeneidade_c + (1|Local), 
              data = riqueza_por_ponto, 
              family = poisson,
              control = glmerControl(optimizer = "bobyqa"))

m5_c <- glmer(riqueza ~ prop_hab_natural_c + heterogeneidade_c + contexto + (1|Local), 
              data = riqueza_por_ponto, 
              family = poisson,
              control = glmerControl(optimizer = "bobyqa"))

tabela_modelos_centrados <- model.sel(m1_c, m2_c, m3_c, m4_c, m5_c)
cat("=== SELE√á√ÉO DE MODELOS (Vari√°veis Centradas) ===\n")
print(tabela_modelos_centrados)

melhor_modelo <- get.models(tabela_modelos_centrados, subset = 1)[[1]]

cat("\nüìä MELHOR MODELO:\n")
cat("AICc:", round(AICc(melhor_modelo), 2), "\n\n")
print(summary(melhor_modelo)$coefficients)

if(length(fixef(melhor_modelo)) > 2) {
  cat("\nüîç VIF:\n")
  print(vif(melhor_modelo))
}
```

---

# An√°lises Multivariadas com mvabund

## Preparar Matrizes
```{r preparar-matrizes}
cat("\n\n")
cat("===============================================================\n")
cat("              PREPARANDO DADOS PARA MVABUND                    \n")
cat("===============================================================\n\n")

# Matriz de comunidade (pontos √ó esp√©cies)
matriz_comunidade_pontos <- dados %>%
  group_by(ID_ponto, Especie) %>%
  summarise(abundancia = n(), .groups = "drop") %>%
  pivot_wider(names_from = Especie, values_from = abundancia, values_fill = 0) %>%
  column_to_rownames("ID_ponto")

cat("üìê Dimens√µes da matriz:", dim(matriz_comunidade_pontos), "\n")
cat("   (", nrow(matriz_comunidade_pontos), " pontos √ó ", 
    ncol(matriz_comunidade_pontos), " esp√©cies)\n\n", sep = "")

# Vari√°veis ambientais
variaveis_pontos <- dados %>%
  group_by(ID_ponto) %>%
  summarise(
    Local = first(Local),
    contexto = first(contexto),
    prop_hab_natural = first(Area_Natural) / first(total_paisagem),
    heterogeneidade = vegan::diversity(
      c(first(Area_Urbana), first(Pastagem), first(Mosaico_Usos),
        first(Areas_nao_veg.), first(Mineracao), first(Lagos), 
        first(Lavouras_Temp.)),
      index = "shannon"
    ),
    .groups = "drop"
  ) %>%
  column_to_rownames("ID_ponto")

# Centrar vari√°veis cont√≠nuas
variaveis_pontos <- variaveis_pontos %>%
  mutate(
    prop_hab_natural_c = scale(prop_hab_natural, center = TRUE, scale = FALSE)[,1],
    heterogeneidade_c = scale(heterogeneidade, center = TRUE, scale = FALSE)[,1]
  )

cat("‚úì Alinhamento de matrizes:", 
    all(rownames(matriz_comunidade_pontos) == rownames(variaveis_pontos)), "\n\n")

# Converter para objeto mvabund
cat("=== CONVERTENDO PARA OBJETO MVABUND ===\n")
mv_comunidade <- mvabund(matriz_comunidade_pontos)

cat("‚úì Objeto mvabund criado com", ncol(mv_comunidade), "esp√©cies\n\n")

# Verificar m√©dia e vari√¢ncia
cat("üìä Diagn√≥stico de dispers√£o:\n")
cat("M√©dia geral:", round(mean(mv_comunidade), 2), "\n")
cat("Vari√¢ncia geral:", round(var(as.vector(mv_comunidade)), 2), "\n")
cat("Raz√£o vari√¢ncia/m√©dia:", round(var(as.vector(mv_comunidade))/mean(mv_comunidade), 2), "\n")

if(var(as.vector(mv_comunidade))/mean(mv_comunidade) > 2) {
  cat("‚ö†Ô∏è Overdispersion detectada ‚Üí usar fam√≠lia binomial negativa\n")
} else {
  cat("‚úì Poisson pode ser apropriada\n")
}
```

## Explorando Rela√ß√µes M√©dia-Vari√¢ncia
```{r mean-var-plot, fig.width=10, fig.height=7}
cat("\n=== EXPLORANDO RELA√á√ÉO M√âDIA-VARI√ÇNCIA ===\n")

plot(mv_comunidade, 
     col = viridis(54),
     pch = 16,
     main = "Rela√ß√£o M√©dia-Vari√¢ncia por Esp√©cie",
     xlab = "M√©dia", 
     ylab = "Vari√¢ncia")
abline(a = 0, b = 1, col = "red", lwd = 2, lty = 2)
legend("topleft", 
       legend = c("Linha 1:1 (Poisson)", "Dados observados"),
       col = c("red", viridis(1)),
       lty = c(2, NA),
       pch = c(NA, 16),
       lwd = c(2, NA))

cat("\nüí° Se os pontos est√£o acima da linha 1:1 ‚Üí overdispersion ‚Üí use binomial negativa\n")
```

## Modelos Multivariados (manyglm)

### Testando Diferentes Modelos
```{r manyglm-modelos}
cat("\n\n")
cat("===============================================================\n")
cat("             AJUSTANDO MODELOS MULTIVARIADOS                   \n")
cat("===============================================================\n\n")

cat("üîß Ajustando modelos com fam√≠lia binomial negativa...\n")
cat("(Isso pode demorar alguns minutos)\n\n")

# Modelo 1: Apenas contexto
cat("Modelo 1: contexto\n")
mv_mod1 <- manyglm(mv_comunidade ~ contexto, 
                   data = variaveis_pontos, 
                   family = "negative.binomial")

# Modelo 2: Habitat natural
cat("Modelo 2: prop_hab_natural_c\n")
mv_mod2 <- manyglm(mv_comunidade ~ prop_hab_natural_c, 
                   data = variaveis_pontos, 
                   family = "negative.binomial")

# Modelo 3: Heterogeneidade
cat("Modelo 3: heterogeneidade_c\n")
mv_mod3 <- manyglm(mv_comunidade ~ heterogeneidade_c, 
                   data = variaveis_pontos, 
                   family = "negative.binomial")

# Modelo 4: Aditivo (habitat + heterogeneidade)
cat("Modelo 4: prop_hab_natural_c + heterogeneidade_c\n")
mv_mod4 <- manyglm(mv_comunidade ~ prop_hab_natural_c + heterogeneidade_c, 
                   data = variaveis_pontos, 
                   family = "negative.binomial")

# Modelo 5: Com intera√ß√£o
cat("Modelo 5: prop_hab_natural_c * heterogeneidade_c\n")
mv_mod5 <- manyglm(mv_comunidade ~ prop_hab_natural_c * heterogeneidade_c, 
                   data = variaveis_pontos, 
                   family = "negative.binomial")

# Modelo 6: Completo (habitat + heterogeneidade + contexto)
cat("Modelo 6: prop_hab_natural_c + heterogeneidade_c + contexto\n")
mv_mod6 <- manyglm(mv_comunidade ~ prop_hab_natural_c + heterogeneidade_c + contexto, 
                   data = variaveis_pontos, 
                   family = "negative.binomial")

cat("\n‚úì Todos os modelos ajustados!\n")
```

### Testes de Hip√≥teses (Multivariados)
```{r anova-manyglm}
cat("\n\n")
cat("===============================================================\n")
cat("           TESTES DE HIP√ìTESES MULTIVARIADOS                   \n")
cat("===============================================================\n\n")

cat("Realizando testes de permuta√ß√£o (999 permuta√ß√µes)...\n")
cat("M√©todo: PIT-trap resampling\n\n")

# Teste para cada modelo
cat("--- MODELO 1: Contexto ---\n")
anova_mod1 <- anova(mv_mod1, 
                    nBoot = 999, 
                    p.uni = "none",
                    resamp = "perm.resid")
print(anova_mod1)

cat("\n--- MODELO 2: Habitat Natural ---\n")
anova_mod2 <- anova(mv_mod2, 
                    nBoot = 999, 
                    p.uni = "none",
                    resamp = "perm.resid")
print(anova_mod2)

cat("\n--- MODELO 3: Heterogeneidade ---\n")
anova_mod3 <- anova(mv_mod3, 
                    nBoot = 999, 
                    p.uni = "none",
                    resamp = "perm.resid")
print(anova_mod3)

cat("\n--- MODELO 4: Aditivo (Habitat + Heterogeneidade) ---\n")
anova_mod4 <- anova(mv_mod4, 
                    nBoot = 999, 
                    p.uni = "none",
                    resamp = "perm.resid")
print(anova_mod4)

cat("\n--- MODELO 5: Com Intera√ß√£o ---\n")
anova_mod5 <- anova(mv_mod5, 
                    nBoot = 999, 
                    p.uni = "none",
                    resamp = "perm.resid")
print(anova_mod5)

cat("\n--- MODELO 6: Completo ---\n")
anova_mod6 <- anova(mv_mod6, 
                    nBoot = 999, 
                    p.uni = "none",
                    resamp = "perm.resid")
print(anova_mod6)

# Tabela resumo
cat("\n\nüìä RESUMO DOS TESTES MULTIVARIADOS:\n")
resumo_testes <- data.frame(
  Modelo = c("Contexto", 
             "Habitat Natural", 
             "Heterogeneidade",
             "Habitat + Heterogeneidade",
             "Habitat * Heterogeneidade",
             "Habitat + Heterogeneidade + Contexto"),
  Dev_Explained = c(
    paste0(round(anova_mod1$table[1,3], 1), "%"),
    paste0(round(anova_mod2$table[1,3], 1), "%"),
    paste0(round(anova_mod3$table[1,3], 1), "%"),
    "ver tabela",
    "ver tabela",
    "ver tabela"
  ),
  p_value = c(
    anova_mod1$table[1, 4],
    anova_mod2$table[1, 4],
    anova_mod3$table[1, 4],
    "ver tabela",
    "ver tabela",
    "ver tabela"
  )
)
print(resumo_testes)
```

### Modelo Bloqueado (Controla Pseudorreplica√ß√£o)
```{r manyglm-bloqueado}
cat("\n\n")
cat("===============================================================\n")
cat("          MODELO BLOQUEADO (CONTROLA LOCAL)                    \n")
cat("===============================================================\n\n")

cat("Testando efeito de CONTEXTO controlando Local como bloco...\n\n")

# Modelo com Local como bloco
mv_mod_blocked <- manyglm(mv_comunidade ~ contexto + Local, 
                          data = variaveis_pontos, 
                          family = "negative.binomial")

cat("Teste para CONTEXTO (bloqueando Local):\n")
anova_blocked <- anova(mv_mod_blocked, 
                       nBoot = 999,
                       p.uni = "none",
                       resamp = "perm.resid",
                       test = "LR")  # Likelihood Ratio test
print(anova_blocked)

cat("\nüí° Este modelo controla a pseudorreplica√ß√£o dos pontos dentro de cada local!\n")
cat("√â an√°logo ao ANOSIM bloqueado da an√°lise anterior.\n")
```

## Testes Univariados (Esp√©cies Indicadoras)
```{r testes-univariados}
cat("\n\n")
cat("===============================================================\n")
cat("     TESTES UNIVARIADOS - IDENTIFICANDO ESP√âCIES-CHAVE         \n")
cat("===============================================================\n\n")

cat("Identificando quais esp√©cies respondem aos preditores...\n\n")

# Escolher o modelo mais relevante (exemplo: modelo 4 - aditivo)
cat("--- MODELO ADITIVO: Habitat + Heterogeneidade ---\n")
anova_uni <- anova(mv_mod4, 
                   nBoot = 999, 
                   p.uni = "adjusted",  # *** IMPORTANTE: testes univariados ***
                   resamp = "perm.resid")

cat("\nüìä RESULTADOS MULTIVARIADOS:\n")
print(anova_uni$table)

cat("\n\nüìã RESULTADOS UNIVARIADOS (por esp√©cie):\n")
cat("Esp√©cies significativas para cada preditor:\n\n")

# Habitat Natural
cat("--- Habitat Natural ---\n")
uni_habitat <- anova_uni$uni.p[1, ]
especies_sig_habitat <- names(uni_habitat[uni_habitat < 0.05])
cat("Esp√©cies significativas (p < 0.05):", length(especies_sig_habitat), "\n")
if(length(especies_sig_habitat) > 0) {
  print(sort(uni_habitat[especies_sig_habitat]))
}

# Heterogeneidade
cat("\n--- Heterogeneidade ---\n")
uni_het <- anova_uni$uni.p[2, ]
especies_sig_het <- names(uni_het[uni_het < 0.05])
cat("Esp√©cies significativas (p < 0.05):", length(especies_sig_het), "\n")
if(length(especies_sig_het) > 0) {
  print(sort(uni_het[especies_sig_het]))
}

# Criar tabela de esp√©cies indicadoras
cat("\n\nüìä TABELA DE ESP√âCIES INDICADORAS:\n")
especies_indicadoras <- data.frame(
  Especie = colnames(mv_comunidade),
  p_habitat = uni_habitat,
  p_heterog = uni_het
) %>%
  mutate(
    sig_habitat = ifelse(p_habitat < 0.05, "***", 
                        ifelse(p_habitat < 0.10, "*", "")),
    sig_heterog = ifelse(p_heterog < 0.05, "***", 
                        ifelse(p_heterog < 0.10, "*", ""))
  ) %>%
  arrange(p_habitat)

# Mostrar top 20
print(head(especies_indicadoras, 20))
```

### Visualizando Esp√©cies Indicadoras
```{r fig-especies-indicadoras, fig.width=12, fig.height=8}
cat("\n=== VISUALIZANDO ESP√âCIES MAIS RESPONSIVAS ===\n")

# Top esp√©cies respondendo a habitat
top_spp_habitat <- head(especies_indicadoras %>% 
                          filter(p_habitat < 0.05) %>% 
                          arrange(p_habitat), 10)

if(nrow(top_spp_habitat) > 0) {
  cat("\nTop 10 esp√©cies respondendo a Habitat Natural:\n")
  print(top_spp_habitat$Especie)
  
  # Gr√°fico
  abundancias <- matriz_comunidade_pontos[, top_spp_habitat$Especie, drop = FALSE]
  abundancias_long <- abundancias %>%
    rownames_to_column("ID_ponto") %>%
    pivot_longer(-ID_ponto, names_to = "Especie", values_to = "Abundancia") %>%
    left_join(variaveis_pontos %>% 
                rownames_to_column("ID_ponto") %>% 
                select(ID_ponto, prop_hab_natural, contexto), 
              by = "ID_ponto")
  
  p_indicadoras <- ggplot(abundancias_long, 
                          aes(x = prop_hab_natural, y = Abundancia, color = contexto)) +
    geom_point(alpha = 0.6, size = 2) +
    geom_smooth(method = "glm", method.args = list(family = "poisson"), 
                se = TRUE, linewidth = 1) +
    facet_wrap(~Especie, scales = "free_y", ncol = 5) +
    scale_color_manual(values = c("Borda_Urbana" = "#E74C3C", "Zona_Rural" = "#27AE60")) +
    theme_bw(base_size = 10) +
    theme(
      strip.text = element_text(size = 8, face = "bold"),
      legend.position = "top"
    ) +
    labs(
      x = "Propor√ß√£o de Habitat Natural",
      y = "Abund√¢ncia",
      title = "Top 10 Esp√©cies Indicadoras de Habitat Natural",
      color = "Contexto"
    )
  
  print(p_indicadoras)
}
```

## NMDS (Ordena√ß√£o para Visualiza√ß√£o)
```{r nmds}
cat("\n\n")
cat("===============================================================\n")
cat("              NMDS (ORDENA√á√ÉO PARA VISUALIZA√á√ÉO)               \n")
cat("===============================================================\n\n")

cat("üí° NMDS √© usado aqui apenas para visualiza√ß√£o dos padr√µes\n")
cat("Os testes de hip√≥teses s√£o feitos com mvabund!\n\n")

set.seed(123)
nmds_pontos <- metaMDS(matriz_comunidade_pontos, 
                       distance = "bray", 
                       k = 2,
                       trymax = 100,
                       trace = FALSE)

cat("üìä Stress do NMDS (k=2):", round(nmds_pontos$stress, 4), "\n\n")

if(nmds_pontos$stress > 0.20) {
  cat("‚ö†Ô∏è Stress alto! Tentando k=3...\n")
  nmds_pontos <- metaMDS(matriz_comunidade_pontos, 
                         distance = "bray", 
                         k = 3,
                         trymax = 100,
                         trace = FALSE)
  cat("‚úì Novo stress (k=3):", round(nmds_pontos$stress, 4), "\n")
}

# Preparar dados para gr√°ficos
nmds_scores <- as.data.frame(scores(nmds_pontos, display = "sites"))
nmds_scores$ID_ponto <- rownames(nmds_scores)
nmds_scores <- nmds_scores %>%
  left_join(variaveis_pontos %>% rownames_to_column("ID_ponto"), by = "ID_ponto")
```

---

# Visualiza√ß√µes

## NMDS por Contexto
```{r fig-nmds-contexto, fig.cap="Figura 1: Composi√ß√£o de abelhas em bordas urbanas vs zonas rurais", fig.width=10, fig.height=8}
hull_contexto <- nmds_scores %>%
  group_by(contexto) %>%
  slice(chull(NMDS1, NMDS2))

ggplot() +
  geom_polygon(data = hull_contexto, 
               aes(x = NMDS1, y = NMDS2, fill = contexto, group = contexto),
               alpha = 0.3) +
  geom_point(data = nmds_scores, 
             aes(x = NMDS1, y = NMDS2, color = contexto, shape = contexto),
             size = 4, alpha = 0.8) +
  scale_fill_manual(values = c("Borda_Urbana" = "#E74C3C", "Zona_Rural" = "#27AE60")) +
  scale_color_manual(values = c("Borda_Urbana" = "#E74C3C", "Zona_Rural" = "#27AE60")) +
  coord_equal() +
  theme_bw(base_size = 14) +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    panel.grid = element_blank()
  ) +
  labs(
    x = "NMDS1", y = "NMDS2",
    title = paste0("Composi√ß√£o de abelhas: Borda Urbana vs Zona Rural\n(Stress = ", 
                   round(nmds_pontos$stress, 3), ")"),
    subtitle = paste0("mvabund LR = ", 
                      round(anova_mod1$table[1,1], 1), 
                      ", p = ", 
                      round(anova_mod1$table[1,4], 3)),
    color = "Contexto", fill = "Contexto", shape = "Contexto"
  )
```

## NMDS por Local
```{r fig-nmds-local, fig.cap="Figura 2: Composi√ß√£o de abelhas por local", fig.width=11, fig.height=8}
hull_local <- nmds_scores %>%
  group_by(Local) %>%
  slice(chull(NMDS1, NMDS2))

ggplot() +
  geom_polygon(data = hull_local, 
               aes(x = NMDS1, y = NMDS2, fill = Local, group = Local),
               alpha = 0.3) +
  geom_point(data = nmds_scores, 
             aes(x = NMDS1, y = NMDS2, color = Local),
             size = 3.5, alpha = 0.8) +
  scale_fill_viridis_d(option = "turbo") +
  scale_color_viridis_d(option = "turbo") +
  coord_equal() +
  theme_bw(base_size = 14) +
  theme(legend.position = "right", panel.grid = element_blank()) +
  labs(
    x = "NMDS1", y = "NMDS2",
    title = paste0("Composi√ß√£o por Local (Stress = ", round(nmds_pontos$stress, 3), ")")
  )
```

## Gradiente de Habitat Natural
```{r fig-gradiente, fig.cap="Figura 3: Gradiente de propor√ß√£o de habitat natural", fig.width=10, fig.height=8}
ggplot(nmds_scores, aes(x = NMDS1, y = NMDS2, color = prop_hab_natural)) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_viridis_c(name = "Propor√ß√£o\nHabitat Natural", option = "plasma") +
  coord_equal() +
  theme_bw(base_size = 14) +
  theme(panel.grid = element_blank()) +
  labs(
    x = "NMDS1", y = "NMDS2",
    title = paste0("Gradiente de Habitat Natural (Stress = ", 
                   round(nmds_pontos$stress, 3), ")"),
    subtitle = paste0("mvabund: % dev. explicada = ", 
                      round(anova_mod2$table[1,3], 1), 
                      "%, p = ", 
                      round(anova_mod2$table[1,4], 3))
  )
```

## Riqueza vs Habitat Natural
```{r fig-riqueza-habitat, fig.cap="Figura 4: Rela√ß√£o entre riqueza e habitat natural", fig.width=10, fig.height=7}
ggplot(riqueza_por_ponto, aes(x = prop_hab_natural, y = riqueza, color = contexto)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_smooth(method = "glm", method.args = list(family = "poisson"), 
              se = TRUE, linewidth = 1.2) +
  scale_color_manual(values = c("Borda_Urbana" = "#E74C3C", "Zona_Rural" = "#27AE60"),
                     name = "Contexto") +
  theme_bw(base_size = 14) +
  theme(
    legend.position = "top",
    panel.grid.minor = element_blank()
  ) +
  labs(
    x = "Propor√ß√£o de Habitat Natural",
    y = "Riqueza de Esp√©cies",
    title = "Rela√ß√£o entre Habitat Natural e Riqueza de Abelhas"
  )
```

---

# An√°lise Complementar com Transectos (n=18)
```{r analise-transectos}
cat("\n\n")
cat("===============================================================\n")
cat("   AN√ÅLISE USANDO TRANSECTOS COMO UNIDADES AMOSTRAIS (n=18)   \n")
cat("===============================================================\n\n")

# Preparar dados por transecto
dados_transecto <- dados %>%
  mutate(
    transecto = str_remove(Ponto, "[0-9]+"),
    ID_transecto = paste(Local, transecto, sep = "_")
  )

# Matriz de comunidade por transecto
matriz_transecto <- dados_transecto %>%
  group_by(ID_transecto, Especie) %>%
  summarise(abundancia = n(), .groups = "drop") %>%
  pivot_wider(names_from = Especie, 
              values_from = abundancia, 
              values_fill = 0) %>%
  column_to_rownames("ID_transecto")

cat("üìê Dimens√µes:", dim(matriz_transecto), "\n\n")

# Vari√°veis por transecto
vars_transecto <- dados_transecto %>%
  group_by(ID_transecto) %>%
  summarise(
    Local = first(Local),
    transecto = first(transecto),
    contexto = first(contexto),
    prop_hab_natural = mean(Area_Natural / total_paisagem),
    heterogeneidade = mean(vegan::diversity(
      c(Area_Urbana, Pastagem, Mosaico_Usos, Areas_nao_veg., 
        Mineracao, Lagos, Lavouras_Temp.), 
      index = "shannon"
    )),
    .groups = "drop"
  ) %>%
  mutate(
    prop_hab_natural_c = scale(prop_hab_natural, center = TRUE, scale = FALSE)[,1],
    heterogeneidade_c = scale(heterogeneidade, center = TRUE, scale = FALSE)[,1]
  ) %>%
  column_to_rownames("ID_transecto")

# Converter para mvabund
mv_transecto <- mvabund(matriz_transecto)

cat("=== MODELOS MVABUND (TRANSECTOS) ===\n\n")

# Modelos principais
mv_t1 <- manyglm(mv_transecto ~ contexto, 
                 data = vars_transecto, 
                 family = "negative.binomial")

mv_t2 <- manyglm(mv_transecto ~ prop_hab_natural_c, 
                 data = vars_transecto, 
                 family = "negative.binomial")

mv_t3 <- manyglm(mv_transecto ~ prop_hab_natural_c + heterogeneidade_c, 
                 data = vars_transecto, 
                 family = "negative.binomial")

# Modelo bloqueado
mv_t_blocked <- manyglm(mv_transecto ~ contexto + Local, 
                        data = vars_transecto, 
                        family = "negative.binomial")

# Testes
cat("Testando modelos...\n\n")

anova_t1 <- anova(mv_t1, nBoot = 999, p.uni = "none")
anova_t2 <- anova(mv_t2, nBoot = 999, p.uni = "none")
anova_t3 <- anova(mv_t3, nBoot = 999, p.uni = "none")
anova_t_blocked <- anova(mv_t_blocked, nBoot = 999, p.uni = "none")

cat("--- CONTEXTO (Transectos) ---\n")
print(anova_t1$table)

cat("\n--- HABITAT NATURAL (Transectos) ---\n")
print(anova_t2$table)

cat("\n--- ADITIVO (Transectos) ---\n")
print(anova_t3$table)

cat("\n--- BLOQUEADO (Transectos) ---\n")
print(anova_t_blocked$table)

cat("\n\n==============================================================\n")
cat("         COMPARA√á√ÉO: PONTOS (n=54) vs TRANSECTOS (n=18)      \n")
cat("==============================================================\n\n")

comparacao <- data.frame(
  Analise = c(
    "mvabund - Contexto (LR)",
    "mvabund - Habitat Natural (LR)",
    "mvabund - Bloqueado (Contexto, LR)"
  ),
  Pontos_LR = c(
    round(anova_mod1$table[1,1], 1),
    round(anova_mod2$table[1,1], 1),
    round(anova_blocked$table[1,1], 1)
  ),
  Pontos_p = c(
    round(anova_mod1$table[1,4], 3),
    round(anova_mod2$table[1,4], 3),
    round(anova_blocked$table[1,4], 3)
  ),
  Transectos_LR = c(
    round(anova_t1$table[1,1], 1),
    round(anova_t2$table[1,1], 1),
    round(anova_t_blocked$table[1,1], 1)
  ),
  Transectos_p = c(
    round(anova_t1$table[1,4], 3),
    round(anova_t2$table[1,4], 3),
    round(anova_t_blocked$table[1,4], 3)
  )
)

print(comparacao)

cat("\nüí° Resultados consistentes entre escalas sugerem padr√µes robustos!\n")
```

---

# Tabela Resumo Final
```{r tabela-resumo}
resumo_final <- data.frame(
  Analise = c(
    "GLMM - Riqueza (melhor modelo)",
    "mvabund - Contexto",
    "mvabund - Habitat Natural",
    "mvabund - Heterogeneidade",
    "mvabund - Aditivo",
    "mvabund - Bloqueado (Contexto)",
    "Esp√©cies indicadoras (Habitat)",
    "Esp√©cies indicadoras (Heterog.)"
  ),
  Estatistica = c(
    paste0("AICc = ", round(AICc(melhor_modelo), 1)),
    paste0("LR = ", round(anova_mod1$table[1,1], 1)),
    paste0("LR = ", round(anova_mod2$table[1,1], 1)),
    paste0("LR = ", round(anova_mod3$table[1,1], 1)),
    paste0("LR = ", round(anova_mod4$table[1,1], 1)),
    paste0("LR = ", round(anova_blocked$table[1,1], 1)),
    paste0("n = ", length(especies_sig_habitat)),
    paste0("n = ", length(especies_sig_het))
  ),
  p_value = c(
    ifelse(length(fixef(melhor_modelo)) > 2, 
           round(summary(melhor_modelo)$coefficients[2, 4], 4), 
           "‚Äî"),
    round(anova_mod1$table[1,4], 4),
    round(anova_mod2$table[1,4], 4),
    round(anova_mod3$table[1,4], 4),
    "ver tabela",
    round(anova_blocked$table[1,4], 4),
    "‚Äî",
    "‚Äî"
  ),
  Dev_Explained = c(
    "‚Äî",
    paste0(round(anova_mod1$table[1,3], 1), "%"),
    paste0(round(anova_mod2$table[1,3], 1), "%"),
    paste0(round(anova_mod3$table[1,3], 1), "%"),
    "ver tabela",
    paste0(round(anova_blocked$table[1,3], 1), "%"),
    "‚Äî",
    "‚Äî"
  )
)

resumo_final
```

---

# Conclus√µes

## Principais Resultados

### 1. Vantagens do mvabund sobre ANOSIM

‚úÖ **Modela a distribui√ß√£o dos dados**: Usa binomial negativa para dados de contagem com overdispersion
‚úÖ **Testa covari√°veis cont√≠nuas**: N√£o precisa categorizar vari√°veis
‚úÖ **Testes univariados**: Identifica quais esp√©cies respondem aos gradientes
‚úÖ **Infer√™ncia baseada em modelos**: Estat√≠stica mais robusta que testes baseados em ranks
‚úÖ **Flexibilidade**: Pode incluir m√∫ltiplos preditores, intera√ß√µes, e efeitos de bloco

### 2. Composi√ß√£o Beta (mvabund)

- **manyglm** revelou que a composi√ß√£o de esp√©cies responde significativamente aos gradientes ambientais
- **Testes multivariados** mostraram efeitos de contexto, habitat natural e/ou heterogeneidade
- **Modelo bloqueado** controlou a pseudorreplica√ß√£o atrav√©s da inclus√£o de Local como preditor
- **Testes univariados** identificaram esp√©cies-chave que impulsionam os padr√µes observados
- **% deviance explicada** quantifica a for√ßa dos efeitos

### 3. Identifica√ß√£o de Esp√©cies Indicadoras

‚úÖ Testes univariados identificaram esp√©cies espec√≠ficas respondendo a cada preditor
‚úÖ Estas esp√©cies podem ser usadas como indicadoras de qualidade de habitat
‚úÖ Gr√°ficos mostram as respostas individuais das esp√©cies aos gradientes

### 4. An√°lise em M√∫ltiplas Escalas

- Compara√ß√£o entre pontos (n=54) e transectos (n=18)
- Resultados consistentes entre escalas indicam padr√µes robustos
- Diferen√ßas entre escalas podem revelar processos dependentes de escala

## Destaques Metodol√≥gicos

‚úÖ **Controle de Pseudorreplica√ß√£o**: GLMM + modelo bloqueado no mvabund
‚úÖ **Distribui√ß√£o Apropriada**: Binomial negativa para dados de contagem com overdispersion
‚úÖ **Infer√™ncia Robusta**: Testes de permuta√ß√£o com PIT-trap resampling
‚úÖ **Identifica√ß√£o de Drivers**: Testes univariados revelam esp√©cies-chave
‚úÖ **M√∫ltiplas Escalas**: An√°lises em n√≠vel de ponto e transecto
‚úÖ **Visualiza√ß√µes Integradas**: NMDS para visualiza√ß√£o + mvabund para testes

## mvabund vs ANOSIM: Quando Usar Cada Um?

**Use mvabund quando:**
- Seus dados s√£o contagens de abund√¢ncia
- Voc√™ quer testar efeitos de vari√°veis cont√≠nuas
- Voc√™ quer identificar esp√©cies indicadoras
- Voc√™ precisa de infer√™ncia baseada em modelos
- Voc√™ tem interesse em efeitos de m√∫ltiplos preditores

**Use ANOSIM quando:**
- Voc√™ tem apenas dados de presen√ßa/aus√™ncia ou dados transformados
- Voc√™ quer um teste simples e r√°pido
- Voc√™ est√° interessado apenas em diferen√ßas entre grupos categ√≥ricos
- Voc√™ quer um teste robusto a diferen√ßas de dispers√£o

## Arquivos Gerados

Este script gera automaticamente:
- ‚úÖ Figuras de alta qualidade (NMDS, gradientes, esp√©cies indicadoras)
- ‚úÖ Tabelas de resultados multivariados e univariados
- ‚úÖ Este relat√≥rio HTML completo e reproduz√≠vel
- ‚úÖ Compara√ß√µes entre diferentes escalas de an√°lise

---

# Refer√™ncias Principais

**mvabund package:**
Wang, Y., Naumann, U., Wright, S. T., & Warton, D. I. (2012). mvabund‚Äìan R package for model‚Äêbased analysis of multivariate abundance data. *Methods in Ecology and Evolution*, 3(3), 471-474.

**Modelo-based approach:**
Warton, D. I., Wright, S. T., & Wang, Y. (2012). Distance‚Äêbased multivariate analyses confound location and dispersion effects. *Methods in Ecology and Evolution*, 3(1), 89-101.

---

# Informa√ß√µes da Sess√£o
```{r sessao}
sessionInfo()
```

---

<div style="text-align: center; margin-top: 50px; padding: 20px; background-color: #f0f0f0; border-radius: 10px;">
**An√°lise realizada em:** `r format(Sys.Date(), '%d/%m/%Y')`

**Vers√£o:** mvabund com an√°lise multiescala e identifica√ß√£o de esp√©cies indicadoras

**Contato:** cinthia.soares@ufvjm.edu.br

---

*Documento gerado com R Markdown*
</div>